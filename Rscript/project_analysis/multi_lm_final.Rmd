---
title: "다항회귀분석"
author: "yoda"
date: "2017년 9월 3일"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### 1. 데이터 로드 및 확인

```{r}
data1 <- read.csv("perfact2.csv")
str(data1)
```

### 2. 연속형 변수 타입 변환(as.numeric) 및 표준화
```{r}
# 연속형 변수의 타입 변환
data1$POSTRELGAP <- as.numeric(data1$POSTRELGAP)
data1$POSTNEXTGAP <- as.numeric(data1$POSTNEXTGAP)
data1$RELPRICE   <- as.numeric(data1$RELPRICE)
data1$FALLRATE <- as.numeric(data1$FALLRATE)

# min, max를 이용하는 표준화 변환 함수 정의
normal <- function(x){
  return ((x-min(x)) / (max(x)-min(x)))
}

# 연속형 변수의 표준화
data1$POSTRELGAP  <- normal(data1$POSTRELGAP)
data1$POSTNEXTGAP  <- normal(data1$POSTNEXTGAP)
data1$RELPRICE   <- normal(data1$RELPRICE)
data1$FALLRATE <- normal(data1$FALLRATE)
str(data1)
```
종속변수 중고판매가격(POSTPRICE)를 설명하는 변수인 POSTRELGAP, POSTNEXTGAP, RELPRICE, FALLRATE의 단위가 다르기 때문에 표준화를 해야한다.
표준화방법에는 scale()을 통한 z변환, min값과 max값을 이용하는 [0~1]변환이 있으며 여기서는 [0~1]변환을 사용한다.


### 3. 연속형 독립변수 간의 상관계수 확인
```{r}
# 연속형 변수만 따로 분리하여 데이터프레임 생성
co <- data.frame(data1$POSTRELGAP, data1$POSTNEXTGAP, data1$RELPRICE, data1$FALLRATE)

# 변수간 상관계수 확인. 상관계수는 -1 ~ 1 사이의 값을 가지며
# 0.8 이상이면 다중공선성이 있을 확률이 높다.
cor(co)

```
상관계수 확인 결과 POSTRELGAP~POSTNEXTGAP 과 POSTRELGAP~FALLRATE의 상관계수가 0.8이 넘는 것을 확인할 수 있다.


### ANOVA
```{r}

```



### 4. 다항회귀분석

```{r}
lm.fit <- lm(POSTPRICE~KRNAME+GB+CONTRACT+GUARANTEE+CHANGES+CONDITIONS+COMPONENT+SOLD
          +POSTRELGAP+POSTNEXTGAP+RELPRICE+FALLRATE, data=data1)
summary(lm.fit)
```
종속변수를 중고판매가(SOLDPRICE)로 설정하고 회귀분석 실시한 결과 p-value: < 2.2e-16로 회귀모델은
유의하다고 판단할 수 있다. 또한 Multiple R-squared가 0.9975로 독립변수들이 종속변수들을 99.75%만큼
설명할 수 있다.
하지만 Multiple R-squared가 1에 가까운 것에 비해 상대적으로 계수들의 검정통계량이 작아 다중공선성을 의심해야 한다.

```{r}
# 회귀분석시 독립변수들의 형식확인
head(model.matrix(lm.fit), 2)
```
범주형 변수들은 자동적으로 더미변수로 처리하여 분석을 실행하는 것을 볼 수 있다.
### 5. ANOVA
```{r}
anova(lm.fit)
```
ANOVA는 독립변수들이 종속변수들에 대해 유의한지 판단하기 위한 분석이다.
회귀분석모델로 ANOVA 실시 결과 모든 독립변수들이 Pr(>F) < 2.2e-16로 전부 유의하다.

### 6. 다중공선성 확인
```{r}
library(car)
sqrt(vif(lm(POSTPRICE~POSTRELGAP+POSTNEXTGAP+RELPRICE+FALLRATE, data=data1))) >2
library(usdm)
co1 <- data.frame(data1$POSTPRICE, data1$POSTRELGAP, data1$POSTNEXTGAP, data1$RELPRICE, data1$FALLRATE)
str(co1)
vif(lm.fit)
```


### 7. 다중공선성이 있는 변수 제거 후 다항회귀분석
```{r}
lm.fit2 <- lm(POSTPRICE~KRNAME+GB+CONTRACT+GUARANTEE+CHANGES+CONDITIONS+COMPONENT+SOLD+RELPRICE, data=data1)
summary(lm.fit2)
```



### 8. 최적의 회귀분석모델을 얻기 위해 STEPWISE 실시
```{r}
lm.fit.step <- step(lm.fit2, direction="both")
```
최종적으로 선택된 설명변수는 다음과 같다.

```{r}
formula(lm.fit.step)
```


### 9. STEPWISE를 통해 최종적으로 선택된 변수로 최상의 회귀분석 실행
```{r}
lm.fit.best <- lm(formula(lm.fit.step), data=data1)
summary(lm.fit.best)
```


```{r}
plot(lm.fit.best)
```
# ANOVA
```{r}
# anova(lm1)
```

# 다항회귀분석시 각 독립변수가 어떤 방식으로 쓰였는지 확인

```{r}
# tail(model.matrix(lm1))

```

# 유의한 변수를 넣기위해 stepwise 실ㅎ
```{r}
# lm1.step <- step(lm1, direction="both")
# formula(lm1.step)
```

# 다항회귀분석의 최종모델확인
```{r}
# multi.best.lm1 <- lm(formula(lm1.step), data=df)
# summary(multi.best.lm1)

```

